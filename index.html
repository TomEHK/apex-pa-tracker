<!doctype html>
<html lang="zh-HK">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>APEX PA Tracker（Firebase 同步）</title>

  <style>
    body{margin:0;background:#0b0f17;color:#e8eefc;font-family:system-ui,-apple-system,Segoe UI,Roboto}
    .wrap{max-width:980px;margin:auto;padding:18px}
    h1{font-size:20px;margin:0 0 10px}
    .card{background:#111a2b;border:1px solid #223046;border-radius:14px;padding:14px;margin-bottom:12px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    input,button{background:#0b1322;border:1px solid #2a3a60;color:#e8eefc;border-radius:10px;padding:10px;font-size:14px}
    button.primary{background:#246bff;border-color:#246bff}
    button.danger{background:#ff2d55;border-color:#ff2d55}
    table{width:100%;border-collapse:collapse;font-size:13px}
    th,td{border-bottom:1px solid #223046;padding:6px;text-align:left}
    .right{text-align:right}
    .muted{opacity:.7;font-size:12px}
  </style>
</head>
<body>
<div class="wrap">
  <h1>APEX PA Tracker（30% 規則 + 8 / 5 日）</h1>

  <!-- 登入卡 -->
  <div class="card" id="authCard">
    <div class="row">
      <button id="btnLogin" class="primary">用 Google 登入</button>
      <button id="btnLogout" class="danger" style="display:none">登出</button>
      <span id="userInfo" class="muted"></span>
    </div>
  </div>

  <!-- 輸入 -->
  <div class="card">
    <div class="row">
      <input type="date" id="date">
      <input type="number" id="profit" placeholder="當日 Profit（可負）">
      <button id="add" class="primary">加入</button>
    </div>
  </div>

  <!-- 狀態 -->
  <div class="card">
    <div class="row">
      <div>累計 Profit：<b id="total">$0</b></div>
      <div>最大單日：<b id="maxDay">$0</b></div>
      <div>最大佔比：<b id="ratio">0%</b></div>
    </div>
  </div>

  <!-- 表格 -->
  <div class="card">
    <table>
      <thead>
        <tr>
          <th>日期</th>
          <th class="right">當日</th>
          <th class="right">累計</th>
        </tr>
      </thead>
      <tbody id="rows"></tbody>
    </table>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import { getFirestore, doc, setDoc, onSnapshot, serverTimestamp, getDoc } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyD0Yhl5BEfuD-Aldk__pQwC_0B6SmKEdIE",
    authDomain: "apex-pa-tracker-17d96.firebaseapp.com",
    projectId: "apex-pa-tracker-17d96",
    appId: "1:772114017433:web:28f74fbd261aeb4d2c1c08"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const provider = new GoogleAuthProvider();

  // UI
  const btnLogin = document.getElementById("btnLogin");
  const btnLogout = document.getElementById("btnLogout");
  const userInfo = document.getElementById("userInfo");
  const rowsEl = document.getElementById("rows");
  const totalEl = document.getElementById("total");
  const maxDayEl = document.getElementById("maxDay");
  const ratioEl = document.getElementById("ratio");

  const dateEl = document.getElementById("date");
  const profitEl = document.getElementById("profit");
  const addBtn = document.getElementById("add");

  btnLogin.onclick = async () => {
    try { await signInWithPopup(auth, provider); }
    catch(e){ alert("登入失敗：" + (e?.message || e)); }
  };
  btnLogout.onclick = async () => { try { await signOut(auth); } catch(e){} };

  let unsub = null;

  onAuthStateChanged(auth, (user) => {
    if (!user) {
      btnLogin.style.display = "";
      btnLogout.style.display = "none";
      userInfo.textContent = "未登入";
      rowsEl.innerHTML = "";
      totalEl.textContent = "$0";
      maxDayEl.textContent = "$0";
      ratioEl.textContent = "0%";
      return;
    }

    btnLogin.style.display = "none";
    btnLogout.style.display = "";
    userInfo.textContent = user.email || "";

    const userRef = doc(db, "users", user.uid);

    // realtime sync
    if (unsub) unsub();
    unsub = onSnapshot(userRef, (snap) => {
      const list = snap.exists() ? (snap.data().records || []) : [];
      render(list);
    }, (err) => {
      alert("讀取雲端失敗：" + (err?.message || err));
    });

    // write
    addBtn.onclick = async () => {
      try {
        const d = dateEl.value;
        const p = Number(profitEl.value);
        if (!d) return alert("請先揀日期");
        if (!isFinite(p)) return alert("請輸入有效 Profit（例如 220 或 -250）");

        const snap = await getDoc(userRef);
        const list = snap.exists() ? (snap.data().records || []) : [];

        // 同一日期：更新；否則新增
        const idx = list.findIndex(x => x.d === d);
        if (idx >= 0) list[idx] = { ...list[idx], d, p, t: Date.now() };
        else list.push({ d, p, t: Date.now() });

        // 只更新 records + updated（用 merge 防止覆蓋其他欄位）
        await setDoc(userRef, { records: list, updated: serverTimestamp() }, { merge: true });

        profitEl.value = "";
      } catch (e) {
        alert("寫入失敗：" + (e?.message || e));
        console.error(e);
      }
    };
  });

  function render(list) {
    rowsEl.innerHTML = "";
    let total = 0;
    let maxDay = 0;

    // 排序（按日期）
    const sorted = [...list].sort((a,b) => (a.d < b.d ? -1 : a.d > b.d ? 1 : 0));

    for (const r of sorted) {
      total += Number(r.p || 0);
      maxDay = Math.max(maxDay, Number(r.p || 0));
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${r.d}</td><td class="right">${r.p}</td><td class="right">${total}</td>`;
      rowsEl.appendChild(tr);
    }

    totalEl.textContent = "$" + total;
    maxDayEl.textContent = "$" + maxDay;
    ratioEl.textContent = total > 0 ? ((maxDay / total) * 100).toFixed(1) + "%" : "0%";
  }
</script>
</body>
</html>

