<!doctype html>
<html lang="zh-HK">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>APEX PA Tracker（Firebase 同步）</title>

  <style>
    body{margin:0;background:#0b0f17;color:#e8eefc;font-family:system-ui,-apple-system,Segoe UI,Roboto}
    .wrap{max-width:980px;margin:auto;padding:18px}
    h1{font-size:20px;margin:0 0 10px}
    .card{background:#111a2b;border:1px solid #223046;border-radius:14px;padding:14px;margin-bottom:12px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    input,button{background:#0b1322;border:1px solid #2a3a60;color:#e8eefc;border-radius:10px;padding:10px;font-size:14px}
    button.primary{background:#246bff;border-color:#246bff}
    button.danger{background:#ff2d55;border-color:#ff2d55}
    table{width:100%;border-collapse:collapse;font-size:13px}
    th,td{border-bottom:1px solid #223046;padding:6px;text-align:left}
    .right{text-align:right}
    .muted{opacity:.7;font-size:12px}
  </style>
</head>
<body>
<div class="wrap">
  <h1>APEX PA Tracker（30% 規則 + 8 / 5 日）</h1>

  <!-- 登入卡 -->
  <div class="card" id="authCard">
    <div class="row">
      <button id="btnLogin" class="primary">用 Google 登入</button>
      <button id="btnLogout" class="danger" style="display:none">登出</button>
      <span id="userInfo" class="muted"></span>
    </div>
  </div>

  <!-- 輸入 -->
  <div class="card">
    <div class="row">
      <input type="date" id="date">
      <input type="number" id="profit" placeholder="當日 Profit（可負）">
      <button id="add" class="primary">加入</button>
    </div>
  </div>

  <!-- 狀態 -->
  <div class="card">
    <div class="row">
      <div>累計 Profit：<b id="total">$0</b></div>
      <div>最大單日：<b id="maxDay">$0</b></div>
      <div>最大佔比：<b id="ratio">0%</b></div>
    </div>
  </div>

  <!-- 表格 -->
  <div class="card">
    <table>
      <thead>
        <tr>
          <th>日期</th>
          <th class="right">當日</th>
          <th class="right">累計</th>
        </tr>
      </thead>
      <tbody id="rows"></tbody>
    </table>
  </div>
</div>

<script type="module">
  // ===== Firebase =====
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import { getFirestore, doc, setDoc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyD0Yhl5BEfuD-Aldk__pQwC_0B6SmKEdIE",
    authDomain: "apex-pa-tracker-17d96.firebaseapp.com",
    projectId: "apex-pa-tracker-17d96",
    appId: "1:772114017433:web:28f74fbd261aeb4d2c1c08"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const provider = new GoogleAuthProvider();

  // ===== UI =====
  const btnLogin = document.getElementById("btnLogin");
  const btnLogout = document.getElementById("btnLogout");
  const userInfo = document.getElementById("userInfo");
  const rows = document.getElementById("rows");
  const totalEl = document.getElementById("total");
  const maxDayEl = document.getElementById("maxDay");
  const ratioEl = document.getElementById("ratio");

  btnLogin.onclick = () => signInWithPopup(auth, provider);
  btnLogout.onclick = () => signOut(auth);

  let unsub = null;

  onAuthStateChanged(auth, user => {
    if (!user) {
      btnLogin.style.display = "";
      btnLogout.style.display = "none";
      userInfo.textContent = "未登入";
      rows.innerHTML = "";
      totalEl.textContent = "$0";
      return;
    }

    btnLogin.style.display = "none";
    btnLogout.style.display = "";
    userInfo.textContent = user.email;

    const ref = doc(db, "users", user.uid);
    if (unsub) unsub();
    unsub = onSnapshot(ref, snap => {
      const data = snap.exists() ? snap.data().records || [] : [];
      render(data);
    });

    document.getElementById("add").onclick = async () => {
      const d = document.getElementById("date").value;
      const p = Number(document.getElementById("profit").value);
      if (!d || isNaN(p)) return;

      const snap = await ref.get();
      const list = snap.exists() ? snap.data().records || [] : [];
      list.push({ d, p, t: Date.now() });

      await setDoc(ref, { records: list, updated: serverTimestamp() });
    };
  });

  function render(list) {
    rows.innerHTML = "";
    let total = 0;
    let maxDay = 0;

    list.forEach(r => {
      total += r.p;
      maxDay = Math.max(maxDay, r.p);
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${r.d}</td><td class="right">${r.p}</td><td class="right">${total}</td>`;
      rows.appendChild(tr);
    });

    totalEl.textContent = "$" + total;
    maxDayEl.textContent = "$" + maxDay;
    ratioEl.textContent = total > 0 ? ((maxDay / total) * 100).toFixed(1) + "%" : "0%";
  }
</script>
</body>
</html>
